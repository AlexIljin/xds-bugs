<html>
<head>
  <title>Ошибки компилятора Native XDS-x86 Modula-2/Oberon-2</title>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
</head>
<body>
  <h1>Ошибки компилятора Native XDS-x86 Modula-2/Oberon-2</h1>
  <p><a href="http://www.excelsior.ru/products/xds.html">Компилятор XDS</a> хороший, но он ошибается. Иногда просто не может что-то переварить, а иногда и создаёт программу, не соответствующую исходнику. С первым можно как-то мириться, ведь ошибка видна уже в процессе компиляции, и можно попытаться написать по-другому. А во втором случае приходится проявлять особую осторожность: из-за нестабильной природы ошибок здесь не всегда поможет даже тестирование.</p>
  <p>За время работы с XDS (с 2007 по 2012 год) я повстречал несколько ошибок. Для всех из них я смог создать проекты минимального размера - такие, чтобы присутствие именно этой конкретной ошибки стало очевидно и надёжно воспроизводилось. Этот набор тестов я и предлагаю вашему вниманию. С помощью этого набора я оцениваю прогресс когда выходит очередная версия XDS. Правда, понятно, что такой метод оценивания не учитывает привнесённые ошибки новых версий, которые ещё только предстоит найти. Да и невозможность воспроизвести ошибку иной раз может не означать, что ошибка исправлена. Может быть, она просто надёжнее спряталась. К сожалению, разработчики XDS не радуют подробной отчётностью о проделанной работе, поэтому и приходится изобретать свои способы оценки.</p>
  <p>Кроме того, учёт найденных сбоев просто позволяет следовать принципу "знай свой инструмент", и учит избегать тех или иных "опасных" (в смысле ненадёжности) конструкций, опций и т.&nbsp;п.</p>
  <p>Все сбои воспроизводятся в свежеустановленном XDS. Если требуются какие-либо дополнительные опции, то они включены в исходный текст модулей в виде директив компилятора &lt;*&#133;*&gt;. Консольная выдача записана с помощью последней версии XDS, в которой удалось воспроизвести проблему. Если в какой-то версии ошибка не проявляется, об этом указано в комментариях.</p>
  <h2>Содержание</h2>
  <ol>
    <li><a href="#Results">Выводы</a></li>
    <li>Ошибки компиляции
      <ul>
        <li><a href="#Enum(-1)">Enum(-1)</a></li>
        <li><a href="#LocalRecordAssert">LocalRecordAssert</a></li>
        <li><a href="#LongInvalidCase">LongInvalidCase</a></li>
        <li><a href="#LongInvalidLocation">LongInvalidLocation</a></li>
        <li><a href="#StrPlusChar">StrPlusChar</a></li>
      </ul>
    </li>
    <li>Ошибки кодогенерации
      <ul>
        <li><a href="#LocalPtrInit">LocalPtrInit</a></li>
        <li><a href="#LocalRecordPtrInit">LocalRecordPtrInit</a></li>
        <li><a href="#OptimizerBug">OptimizerBug</a></li>
        <li><a href="#RecordUnpack">RecordUnpack</a> - не воспроизводится в версии 2.60 beta</li>
        <li><a href="#TypeGuard">TypeGuard</a> - не воспроизводится в версии 2.60 beta</li>
      </ul>
    </li>
  </ol>
  <!-- Добавить описание: Publicity, Projection, Receivers -->
  <h2><a name="Results">1. Выводы</a></h2>
  <p>В самом деле, почему бы не начать сразу с выводов? Как видно из последующих примеров, директиву <strong><code>PROCINLINE</code> лучше отключить</strong> и не включать. Заинлайненые процедуры не дружат с локальными указателями, будь то <a href="#LocalRecordPtrInit">простые переменные</a> или <a href="#LocalRecordPtrInit">поля <code>RECORD</code>'ов</a>. Встречаются и более <a href="#OptimizerBug">серьёзные проблемы</a>, пропадающие при отключении директивы <code>PROCINLINE</code>.</p>
  <p>Все эти найденные ошибки - это не повод сказать "плохой компилятор". Наоборот, компилятор весьма неплох. Просто иной раз вылетает исключение "invalid location" на пустом месте, и не знаешь, что с этим делать и как исправлять. А когда ошибка локализована, и найдена конкретная причина, то появляется определённость. И тогда понимаешь: отдельные мелкие недоработки есть, но их мало, а в остальном-то всё прекрасно работает!</p>
  <h2>2. Ошибки компиляции</h2>
  <ul>
    <li>
    <h3><a name="Enum(-1)">Enum(-1)</a></h3>
    <h4>Исходные тексты модулей для проверки</h4>
    <p>Для этого теста нам понадобятся два модуля: <code>Definition.def</code> и <code>Test.ob2</code>.</p>
<pre>&lt;* ENUMSIZE="4" *&gt;&lt;* M2EXTENSIONS+ *&gt;
DEFINITION MODULE ['StdCall'] Definition;

IMPORT SYSTEM;

TYPE
  FORMAT = (
    FIF_BMP,
    FIF_ICO
  );

CONST
  FIF_UNKNOWN = SYSTEM.CAST (FORMAT, 0FFFFFFFFh);

END Definition.</pre>
<pre>(* <strong>Why is the assignment below impossible, although the comparison works?</strong> *)
&lt;* NOOPTIMIZE+ *&gt; (* This is to avoid constant check elimination. *)
&lt;* MAIN+ *&gt;
MODULE Test;

IMPORT
   Definition, Out, SYSTEM;

VAR
   fmt: Definition.FORMAT;
BEGIN
   (* <strong>The SYSTEM.VAL version works as expected.</strong> *)
   fmt := SYSTEM.VAL (Definition.FORMAT, Definition.FIF_UNKNOWN);
   (* <strong>But the following line would not compile (E122 expression out of bounds)</strong> *)
   fmt := Definition.FIF_UNKNOWN;
   (* <strong>The comparison below is compiled without any complaints.</strong> *)
   IF fmt = Definition.FIF_UNKNOWN THEN
      Out.String ('Constant check 1: OK.');
      Out.Ln;
   ELSE
      Out.String ('Constant check 1: FAILED.');
      Out.Ln;
   END;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
<strong>XDS Modula-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Definition.def"
no errors, no warnings, lines   15, time  0.00, new symfile
XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011
Compiling "test.ob2"

* [test.ob2 15.11 E122]
* <strong>expression out of bounds
   fmt := $Definition.FIF_UNKNOWN;</strong>
errors  1, no warnings, lines   24, time  0.02
-------------------------------------------------------------------
files: 2  errors: 1(0)  lines 39  time: 0:00  speed 10000 l/m</pre>
    <h4>Комментарий</h4>
    <p>Странность здесь заключается в том, что константа <code>Definition.FIF_UNKNOWN</code> по определению имеет тип <code>Definition.FORMAT</code>, но при этом не может напрямую быть присвоена переменной <code>fmt</code> того же типа. Если же с помощью <code>SYSTEM.VAL</code> привести тип к тому, что и так имеется, то присваивание почему-то работает. Возникает вопрос: раз нужно приведение типа, то имеет ли константа изначально тип <code>FORMAT</code> или нет? Тот факт, что <code>IF</code> компилируется без вопросов, говорит о том, что таки да, тип тот самый, иначе была бы ошибка несовпадения типов при сравнении. Но почему же не компилируется присваивание?</p>
    </li>

    <li><h3><a name="LocalRecordAssert">LocalRecordAssert</a></h3>
    <h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* PROCINLINE+ *&gt; (* Allow procedure inlining. *)
&lt;* MAIN+ *&gt;
MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2012 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

IMPORT
   Out;

PROCEDURE InitModule; (* This procedure will be inlined. *)
VAR
   wr: RECORD
      int: INTEGER; (* Any variable will do *)
   END;
BEGIN
   (* <strong>The following code results in compiler crash with message "compilation</strong>
    * <strong>aborted: ASSERT(FALSE,9999) at line 133 of formOMF.ob2".</strong> *)
   IF wr.int # 0 THEN
      Out.String('Test passed!');
   END;
END InitModule;

BEGIN
   InitModule;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"
Generating Test
* [Test.ob2 28.04 W330]
* function InitModule inlined
   $InitModule;

* <strong>[*** 0.00 F450]</strong>
* <strong>compilation aborted: ASSERT(FALSE,9999) at line 133 of formOMF.ob2</strong></pre>
    <h4>Комментарий</h4>
    <p>Если отключить директиву <code>PROCINLINE</code>, то модуль компилируется успешно.</p>
    </li>

    <li><h3><a name="LongInvalidCase">LongInvalidCase</a></h3><h4>Исходный текст модуля для проверки</h4>
<pre>MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2011 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

VAR
   tmp: SHORTINT; (* any integer type will do *)
BEGIN
   INC(tmp, LONG(1000000)); (* <strong>Compiler breaks with error F450: "compilation</strong>
                             * <strong>aborted: invalid case in CASE statement".</strong>
                             * <strong>Remove "LONG" and it will work.</strong> *)
END Test.</pre><h4>Результат запуска компилятора</h4>
<pre>&gt;xc Test.ob2
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"

* <strong>[*** 0.00 F450]</strong>
* <strong>compilation aborted: invalid case in CASE statement at line 1000 of pcF.ob2</strong></pre>
    </li>

    <li><h3><a name="LongInvalidLocation">LongInvalidLocation</a></h3><h4>Исходный текст модуля для проверки</h4>
<pre>MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2010 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

CONST
   c = LONG (0 + 1); (* <strong>This makes the compiler abort with "invalid location".</strong>
                      * <strong>The value of the constant does not matter, and neither</strong>
                      * <strong>does its name. Just as soon as there is an expression</strong>
                      * <strong>inside the LONG: +, -, *.</strong> *)

END Test.</pre><h4>Результат запуска компилятора</h4>
<pre>&gt;xc Test.ob2
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"

* <strong>[*** 0.00 F450]</strong>
* <strong>compilation aborted: invalid location</strong></pre>
    <h4>Комментарий</h4>
    <p><code>LONG здесь</code> - бессмысленная операция с точки зрения языка Oberon. Я ожидал бы, чтобы компилятор её проигнорировал. Возможно, выдал бы какое-то предупреждение или сообщил об ошибке в данном месте. Сообщение же "compilation aborted: invalid location" говорит о том, что внутри самого компилятора есть ошибка, не позволяющая ему штатно обработать ситуацию.</p>
    </li>

    <li>
    <h3><a name="StrPlusChar">StrPlusChar</a></h3>
    <h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* O2EXTENSIONS+ *&gt; (* Allow string concatenation for the constants below.  *)
&lt;* MAIN+ *&gt;
MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2009 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

CONST
   Str1 = 'some string' + 09X; (* <strong>this is compiled, no error</strong> *)
   Tab = 09X;
   Str2 = 'some string' + Tab; (* <strong>same thing, but produces a compilation error:</strong>
                                * <strong>incompatible types:</strong>
                                * <strong>  "string constant (SS)"</strong>
                                * <strong>  "CHAR"</strong>
                                *)
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"

* [Test.ob2 12.25 E029]
* <strong>incompatible types:
    "string constant (SS)"
    "CHAR"</strong>
   Str2 = 'some string' <strong>$+</strong> Tab; (* same thing, but produces a compilatio...
errors  1, no warnings, lines   18, time  0.01</pre>
    <h4>Комментарий</h4>
    <p>Не знаю, есть ли действительные причины для этой ошибки, или это просто недоработка. Просто мне такое непоследовательное поведение компилятора кажется странным, поэтому я считаю это ошибкой. Даже если бы константа <code>Tab</code> была определена в другом модуле, нет причины запрещать использовать её в выражении.</p>
    </li>
  </ul>

  <h2>3. Ошибки кодогенерации</h2>
  <ul>
    <li><h3><a name="LocalPtrInit">LocalPtrInit</a></h3><h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* GENPTRINIT+ *&gt; (* Make sure local pointers are initialized. *)
&lt;* PROCINLINE+ *&gt; (* Allow procedure inlining. *)
&lt;* MAIN+ *&gt;
MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2012 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

IMPORT
   Out;

PROCEDURE InitModule; (* This procedure will be inlined. *)
VAR
   ptr: POINTER TO ARRAY OF CHAR;
BEGIN
   (* <strong>Since GENPTRINIT is ON, the 'ptr' variable must be set NIL, but that</strong>
    * <strong>does not happen. The compiler thinks that there will be an 'invalid</strong>
    * <strong>location' trap and simply generates a call to the trap routine. This is</strong>
    * <strong>very strange, since we don't even dereference the pointer here, so there</strong>
    * <strong>is no reason for that kind of error.</strong> *)
   IF ptr # NIL THEN
      Out.String('Error!');
   ELSE
      Out.String('Test passed.');
   END;
END InitModule;

BEGIN
   InitModule;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"
Generating Test
* [Test.ob2 23.07 W304]
* possibly used before definition "ptr"
   IF $ptr # NIL THEN

* [Test.ob2 23.11 W915]
* invalidLocation exception will be raised here
   IF ptr $# NIL THEN

* [Test.ob2 24.07 W311]
* unreachable code
      $Out.String('Error!');

* [Test.ob2 26.07 W311]
* unreachable code
      $Out.String('Test passed.');

* [Test.ob2 31.04 W330]
* function InitModule inlined
   $InitModule;
no errors, warnings  5, lines   32, time  0.21, new symfile
New "tmp.lnk" is generated using template "d:/Programs/Dev/XDS/bin/xc.tem"

XDS Link Version 2.13.3 Copyright (c) Excelsior 1995-2009.
No errors, no warnings

#RTS: unhandled exception #3: <strong>invalid location at line 23 of Test.ob2</strong>

File errinfo.$$$ created.

  EAX = 00000001  EBX = 7FFD5000
  ECX = 00000000  EDX = 0044B000
  ESI = 00000000  EDI = 00000000
  EBP = 0006FFB8  ESP = 0006FF7C
  EIP = 00401041
 STACK:
  0006FF7C:  00000003 0040E018 00000017 0040E034
  0006FF8C:  0006FFA4 00092170 00000001 001E8480
  0006FF9C:  003D0900 0040C36A 00000001 00092170
  0006FFAC:  00092198 00000001 00092170 0006FFF0
  0006FFBC:  0006FFE0 0040CB91 7C816FD7 00000000
  0006FFCC:  00000000 7FFD5000 8054A6ED 0006FFC8
  0006FFDC:  89288930 FFFFFFFF 7C839AA8 7C816FE0
  0006FFEC:  00000000 00000000 00000000 0040CB60</pre>
    <h4>Комментарий</h4>
    <p>Если отключить директиву <code>PROCINLINE</code>, то тест проходит успешно. Т.&nbsp;е. именно комбинация <code>PROCINLINE+</code> и <code>GENPTRINIT+</code> приводит к ошибке кодогенерации.</p>
    </li>

    <li><h3><a name="LocalRecordPtrInit">LocalRecordPtrInit</a></h3><h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* GENPTRINIT+ *&gt; (* Make sure local pointers are initialized, including RECORD fields. *)
&lt;* PROCINLINE+ *&gt; (* Allow procedure inlining. *)
&lt;* MAIN+ *&gt;
MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2012 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

IMPORT
   Out;

TYPE
   (* A stack-based RECORD type with a POINTER field. *)
   Writer = RECORD
      ptr: POINTER TO ARRAY OF CHAR; (* any pointer type will do *)
   END;

PROCEDURE InitModule; (* This procedure will be inlined. *)
VAR
   wr: Writer;
BEGIN
   (* <strong>Since GENPTRINIT is ON, the field wr.ptr must be set NIL, but that</strong>
    * <strong>does not happen if the procedure is inlined. The compiler simply does</strong>
    * <strong>not generate the initialization code (typically that would be a "push 0"</strong>
    * <strong>instruction), and whatever is in the stack is left in the pointer field.</strong>
    * <strong>In real-life programs this leads to random 'invalid location' traps.</strong> *)
   IF wr.ptr # NIL THEN
      Out.String('Error!');
   ELSE
      Out.String('Test passed.');
   END;
END InitModule;

BEGIN
   InitModule;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Test.ob2"
Generating Test
* [Test.ob2 37.04 W330]
* function InitModule inlined
   $InitModule;
no errors, warnings  1, lines   38, time  0.01, new symfile
New "tmp.lnk" is generated using template "d:/Programs/Dev/XDS/bin/xc.tem"

XDS Link Version 2.13.3 Copyright (c) Excelsior 1995-2009.
No errors, no warnings
<strong>Error!</strong></pre>
    <h4>Комментарий</h4>
    <p>Отличие от <a href="#LocalPtrInit">предыдущего теста</a> заключается в том, что здесь неинициализированный указатель находится внутри стековой записи (<code>RECORD</code>). Как в и предыдущем случае, если отключить директиву <code>PROCINLINE</code>, то тест проходит успешно. Т.&nbsp;е. именно комбинация <code>PROCINLINE+</code> и <code>GENPTRINIT+</code> приводит к ошибке кодогенерации.</p>
    </li>

    <li>
    <h3><a name="OptimizerBug">OptimizerBug</a></h3>
    <h4>Исходный текст проекта для проверки</h4>
    <p><a href="OptimizerBug.zip">Полный проект</a> состоит из трёх модулей, проектного файла с опциями и двух командных bat-файлов. Для проверки нужно запустить файл <code>Run.bat</code>.</p>
    <h4>Результат запуска проверки</h4>
<pre>&gt;Run.bat
O2/M2 development system <strong>v2.60</strong> TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
Make project "Test.prj"
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011</strong>
Compiling "Display.ob2"
no errors, no warnings, lines   24, time  0.01, new symfile
XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011
Compiling "BugHere.ob2"
Generating BugHere
* [BugHere.ob2 70.15 W330]
* function NewField inlined
      f[i] := $NewField(i);

* [BugHere.ob2 84.14 W330]
* function NewFields inlined
    p.new := $NewFields();   (* manually inlining NewFields removes the ...
no errors, warnings  2, lines   90, time  0.05, new symfile
XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011
Compiling "Main.ob2"
no errors, no warnings, lines    9, time  0.03, new symfile
New "obj/tmp.lnk" is generated using template "d:/Programs/Dev/XDS/bin/xc.tem"
-------------------------------------------------------------------
files: 3  errors: 0(2)  lines 123  time: 0:00  speed 10000 l/m

XDS Link Version 2.13.3 Copyright (c) Excelsior 1995-2009.
No errors, no warnings
<strong>Start Init - End Init

The Bug has disappeared</strong>
O2/M2 development system v2.60 TS  (c) 1991-2011 Excelsior, LLC. (build 16.11.2011)
Make project "Test.prj"
XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011
Compiling "BugHere.ob2"
Generating BugHere
* [BugHere.ob2 68.15 W330]
* function NewField inlined
      f[i] := $NewField(i);

* [BugHere.ob2 82.14 W330]
* function NewFields inlined
    p.new := $NewFields();   (* manually inlining NewFields removes the ...
no errors, warnings  2, lines   88, time  0.05, new symfile
XDS Oberon-2 v2.40 [x86, v1.50] - build 16.11.2011
Compiling "Main.ob2"
no errors, no warnings, lines    9, time  0.03
-------------------------------------------------------------------
files: 2  errors: 0(2)  lines 97  time: 0:00  speed 10000 l/m

XDS Link Version 2.13.3 Copyright (c) Excelsior 1995-2009.
No errors, no warnings

#RTS: unhandled exception #3: invalid location

File errinfo.$$$ created.

  EAX = 00000000  EBX = 0040F000
  ECX = 00000000  EDX = 00000001
  ESI = 00000000  EDI = 100340C0
  EBP = 100340D0  ESP = 0006FF44
  EIP = 004010CD
 STACK:
  0006FF44:  00000000 00000000 0040F000 0006FF68
  0006FF54:  00000010 00000000 00000000 0006FFB8
  0006FF64:  00000001 1003C078 100340D0 100340C0
  0006FF74:  00000000 00000000 7FFDF000 0006FFB8
  0006FF84:  00401228 0040F29C 0006FFA4 00092170
  0006FF94:  00000001 001E8480 003D0900 0040C78A
  0006FFA4:  00000001 00092170 00092198 00000001
  0006FFB4:  00092170 0006FFF0 0006FFE0 0040CFB1
<strong>Start Init

The Bug is still present

The Bug was reproduced successfully.</strong></pre>
    <h4>Комментарий</h4>
    <p>Комбинация из следующих опций приводит к воспроизведению данной ошибки: <code>NOPTRALIAS+</code>, <code>CHECKNIL-</code>, <code>DOREORDER+</code>, <code>GENDEBUG-</code>, <code>PROCINLINE+</code>. Если удалить любую из них из файла <code>Test.prj</code> (заменив тем самым на значение по умолчанию), то ошибка не проявится.</p>
    <p>Данная ошибка была выделена из большого проекта, что стоило немалых усилий. На помощь была призвана бесплатная версия дизассемблера IDA Pro. Естественно, в процессе минимизации потребовалось автоматизировать компиляцию и проверку наличия именно искомой ошибки. Для этого были использованы утилиты <code>sed.exe</code>, <code>grep.exe</code>, интерпретатор <code>cmd.exe</code> и отладочная выдача с помощью стандартного модуля <code>Out</code>. Чтобы выполнить проверку, запустите файл <code>Run.bat</code>. Он скомпилирует тестовый проект и вызовет <code>CheckBug.bat</code>, чтобы убедиться, что <em>ошибки нет</em>. (Изначально ошибка "исправлена" двумя пустыми вызовами <code>Disp.String</code> в процедуре <code>BugHere.NewField</code>.) После этого <code>sed.exe</code> используется для того, чтобы удалить вызовы <code>Disp.String</code>, и проект компилируется заново. <code>CheckBug.bat</code> вызывается снова, чтобы убедиться, что удаление этих вызовов <em>вызвало ошибку</em>. Вывод о наличии ошибки выводится в консоль (последняя строка выдачи).</p>
    </li>

    <li>
    <h3><a name="RecordUnpack">RecordUnpack</a></h3>
    <h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* NOOPTIMIZE+ *&gt; (* This option is here to prevent removing the ASSERTs:
                   * compiler thinks that the conditions are TRUE and
                   * eliminates the checks. *)
&lt;* MAIN+ *&gt;
MODULE Test;

(* ------------------------------------------------------------------------
 * (C) 2009 by Alexander Iljin
 * ------------------------------------------------------------------------ *)

IMPORT
   SYSTEM, Out;

PROCEDURE ReproduceBug ();
TYPE
   LowHigh = RECORD
      low, high: INTEGER;
   END;
VAR
   lh: LowHigh;
   longLow, longHigh: LONGINT;
BEGIN
   lh.high := 2000H;
   lh.low  := 1000H;
   ASSERT (lh.high = 2000H, 20);
   ASSERT (lh.low  = 1000H, 21);
   longHigh := lh.high;                      (* <strong>this works                  </strong> *)
   longLow  := SYSTEM.VAL (LONGINT, lh.low); (* <strong>same thing, but doesn't work</strong> *)
   ASSERT (longHigh = 2000H, 60);
   ASSERT (longLow  = 1000H, 61);      (* <strong>error is here: longLow = 20001000H</strong> *)
   Out.String ('Test passed.');
END ReproduceBug;

BEGIN
   ReproduceBug;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.51</strong> (c) 1999-2003 Excelsior, LLC. (build 10.05.2005)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 10.05.2005</strong>
Compiling "Test.ob2"
no errors, no warnings, lines   36, time  0.01, new symfile
New "tmp.lnk" is generated using template "d:/Programs/Dev/XDS/bin/xc.tem"

XDS Link  Version 2.6 Copyright (c) 1995-2001 Excelsior
No errors, no warnings

#RTS: unhandled exception #61: <strong>ASSERT(FALSE, 61)</strong>

File errinfo.$$$ created.</pre>
    <h4>Комментарий</h4>
    <p>В XDS v2.60 beta данная ошибка не воспроизводится, на консоль выдаётся "Test passed".</p>
    </li>

    <li>
    <h3><a name="TypeGuard">TypeGuard</a></h3>
    <h4>Исходный текст модуля для проверки</h4>
<pre>&lt;* O2EXTENSIONS+ *&gt; (* This allows applying a type guard to a procedure result. *)
&lt;* MAIN+ *&gt;
MODULE Test;

IMPORT Out;

TYPE
   Ansector = POINTER TO AnsectorDesc;
   AnsectorDesc = RECORD
   END;

   Descendant = POINTER TO DescendantDesc;
   DescendantDesc = RECORD (AnsectorDesc)
   END;

VAR
   desc: Descendant;
   counter: INTEGER;

PROCEDURE GetThis (): Ansector;
VAR res: Descendant;
BEGIN
   INC(counter);
   NEW (res);
   RETURN res
END GetThis;

BEGIN
   counter := 0;
   desc := GetThis ()(Descendant);
   (* <strong>Although the GetThis procedure is called only once, it will be executed</strong>
    * <strong>twice because of the type guard bug.</strong> *)
   CASE counter OF
   | 1: Out.String('Test passed.');
   | 2: Out.String('Test failed!');
   END;
END Test.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;xc =make Test.ob2 &amp;&amp; Test.exe
O2/M2 development system <strong>v2.51</strong> (c) 1999-2003 Excelsior, LLC. (build 10.05.2005)
<strong>XDS Oberon-2 v2.40 [x86, v1.50] - build 10.05.2005</strong>
Compiling "Test.ob2"
no errors, no warnings, lines   37, time  0.02, new symfile
New "tmp.lnk" is generated using template "d:/Programs/Dev/XDS/bin/xc.tem"

XDS Link  Version 2.6 Copyright (c) 1995-2001 Excelsior
No errors, no warnings
<strong>Test failed!</strong></pre>
    <h4>Комментарий</h4>
    <p>В XDS v2.60 beta данная ошибка не воспроизводится, на консоль выдаётся "Test passed".</p>
    </li>

<!-- template
    <li>
    <h3><a name="TestName">TestName</a></h3>
    <h4>Исходный текст модуля для проверки</h4>
<pre>Module.</pre>
    <h4>Результат запуска компилятора</h4>
<pre>&gt;ConsoleOutput</pre>
    <h4>Комментарий</h4>
    <p></p>
    </li>
-->

  </ul>
  <h2>Автор</h2>
  <p>Нашёл ошибки, создал минимальные проекты для их воспроизведения и разместил в данном документе: <a href="mailto:ajsoft@yandex.ru">Александр Ильин</a>. Если вы знаете о каких-то ошибках, не указанных здесь, пожалуйста, пишите, присылайте проекты для воспроизведения. Если не можете создать маленький модуль, то присылайте большой проект, разберёмся!</p>
</body>
</html>
